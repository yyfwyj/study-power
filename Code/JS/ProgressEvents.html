<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Progress Events Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .progress-container {
        margin: 20px 0;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background-color: #4caf50;
        width: 0%;
        transition: width 0.3s ease;
      }
      .status {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
      }
      .button-container {
        display: flex;
        gap: 10px;
      }
      button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        max-height: 300px;
        overflow-y: auto;
      }
      .result h3 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 16px;
      }
      .result p {
        margin: 5px 0;
        font-family: monospace;
        font-size: 13px;
        word-break: break-all;
      }
      .json-preview {
        background-color: #fff;
        padding: 10px;
        border-radius: 3px;
        border: 1px solid #ddd;
        margin-top: 10px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 150px;
        overflow-y: auto;
      }
      .explanation {
        margin-top: 20px;
        padding: 15px;
        background-color: #e7f3ff;
        border-radius: 4px;
        border-left: 4px solid #007bff;
      }
      .explanation h3 {
        margin: 0 0 10px 0;
        color: #0056b3;
      }
      .explanation ul {
        margin: 10px 0;
        padding-left: 20px;
      }
      .explanation li {
        margin: 5px 0;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <h1>Progress Events æ¼”ç¤º</h1>
    <p>ç‚¹å‡»æŒ‰é’®å‘é€è¯·æ±‚ï¼Œè§‚å¯Ÿè¿›åº¦æ¡çš„å˜åŒ–</p>

    <div class="button-container">
      <button id="sendRequest">å‘é€è¯·æ±‚</button>
      <button id="cancelRequest" disabled="true">å–æ¶ˆè¯·æ±‚</button>
      <button id="suspendRequest" disabled="true">æš‚åœè¯·æ±‚</button>
      <button id="continueRequest" disabled="true">ç»§ç»­è¯·æ±‚</button>
    </div>

    <div class="progress-container">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div id="status" class="status">ç­‰å¾…å¼€å§‹...</div>
    </div>

    <div id="result" class="result" style="display: none">
      <h3>è¯·æ±‚ç»“æœ</h3>
      <p><strong>æ•°æ®æ€»é•¿åº¦:</strong> <span id="dataLength"></span> å­—ç¬¦</p>
      <p><strong>æ•°æ®å¤§å°:</strong> <span id="dataSize"></span> MB</p>
      <div class="json-preview" id="jsonPreview"></div>
    </div>

    <div class="explanation">
      <h3>ğŸš€ Progress äº‹ä»¶è¯¦è§£</h3>
      <ul>
        <li>
          <strong>Progress äº‹ä»¶çš„ä½œç”¨ï¼š</strong
          >åœ¨æ¥æ”¶å¤§æ•°æ®æ—¶ï¼Œæä¾›å®æ—¶çš„ä¸‹è½½è¿›åº¦åé¦ˆ
        </li>
        <li>
          <strong>ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼š</strong
          >å¯¹äºå¤§æ–‡ä»¶ä¸‹è½½ï¼Œç”¨æˆ·éœ€è¦çŸ¥é“è¿›åº¦ï¼Œé¿å…ç•Œé¢å‡æ­»
        </li>
        <li>
          <strong>å…³é”®å±æ€§ï¼š</strong>
          <ul>
            <li><code>event.loaded</code> - å·²æ¥æ”¶çš„å­—èŠ‚æ•°</li>
            <li>
              <code>event.total</code> - æ€»å­—èŠ‚æ•°ï¼ˆéœ€è¦æœåŠ¡å™¨æä¾› Content-Length
              å¤´ï¼‰
            </li>
            <li><code>event.lengthComputable</code> - æ˜¯å¦èƒ½è®¡ç®—è¿›åº¦</li>
          </ul>
        </li>
        <li>
          <strong>æœ¬ç¤ºä¾‹æ¼”ç¤ºï¼š</strong>
          <ul>
            <li>ä¸‹è½½ 10MB JSON æ•°æ®</li>
            <li>å®æ—¶æ˜¾ç¤ºè¿›åº¦æ¡å’Œç™¾åˆ†æ¯”</li>
            <li>æ˜¾ç¤ºå·²æ¥æ”¶å­—èŠ‚æ•°å’Œæ€»å­—èŠ‚æ•°</li>
          </ul>
        </li>
      </ul>
    </div>

    <script>
      const progressFillDOM = document.getElementById("progressFill");
      const sendRequestDOM = document.getElementById("sendRequest");
      const cancelRequestDOM = document.getElementById("cancelRequest");
      const suspendRequestDOM = document.getElementById("suspendRequest");
      const continueRequestDOM = document.getElementById("continueRequest");
      const statusDOM = document.getElementById("status");
      const resultDOM = document.getElementById("result");
      const dataLengthDOM = document.getElementById("dataLength");
      const dataSizeDOM = document.getElementById("dataSize");
      const jsonPreviewDOM = document.getElementById("jsonPreview");

      const xhr = new XMLHttpRequest();

      sendRequestDOM.addEventListener("click", () => {
        progressFillDOM.style.width = "0%";
        statusDOM.textContent = "å¼€å§‹è¯·æ±‚...";
        sendRequestDOM.textContent = "è¯·æ±‚ä¸­...";
        sendRequestDOM.disabled = true;
        dataLengthDOM.textContent = "0";
        cancelRequestDOM.disabled = false;
        suspendRequestDOM.disabled = false;
        continueRequestDOM.disabled = false;

        xhr.onload = () => {
          progressFillDOM.style.width = "100%";
          statusDOM.textContent = "è¯·æ±‚å®Œæˆï¼";
          sendRequestDOM.disabled = false;
          sendRequestDOM.textContent = "é‡æ–°å‘é€è¯·æ±‚ ";
          resultDOM.style.display = "block";
          const data = JSON.parse(xhr.responseText); // å…ˆè§£ææˆå¯¹è±¡
          const preview = JSON.stringify(data, null, 2).substring(0, 1000); // å†æ ¼å¼åŒ–å¹¶æˆªæ–­
          jsonPreviewDOM.textContent = preview;
        };

        xhr.onprogress = (event) => {
          console.log(event);
          const percentComplete = (event.loaded / event.total) * 100;
          const loadedMB = (event.loaded / 1024 / 1024).toFixed(2);
          const totalMb = (event.total / 1024 / 1024).toFixed(2);
          dataLengthDOM.textContent = event.total;
          dataSizeDOM.textContent = loadedMB;
          progressFillDOM.style.width = percentComplete + "%";
          statusDOM.innerHTML = `
              <strong>ğŸ“Š ä¸‹è½½è¿›åº¦:</strong> ${percentComplete.toFixed(2)}%<br>
              <strong>ğŸ“¦ æ•°æ®æ¥æ”¶:</strong> ${loadedMB}MB / ${totalMb}MB<br>
              <strong>ğŸ”¢ å­—èŠ‚è¯¦æƒ…:</strong> ${event.loaded.toLocaleString()} / ${event.total.toLocaleString()} å­—èŠ‚
          `;
        };

        xhr.open(
          "GET",
          "http://127.0.0.1:4523/m1/7590620-7329073-default/xhrStudy/demo01",
          true
        );
        xhr.send(null);
      });

      cancelRequestDOM.addEventListener("click",()=> {
        console.log("å–æ¶ˆè¯·æ±‚");
        xhr.abort();
        cancelRequestDOM.disabled = true;
        suspendRequestDOM.disabled = true;
        continueRequestDOM.disabled = true;
        sendRequestDOM.disabled = false;
        progressFillDOM.style.width = "0%";
        statusDOM.textContent = "è¯·æ±‚å–æ¶ˆï¼";
        sendRequestDOM.textContent = "é‡æ–°å‘é€è¯·æ±‚ ";
        resultDOM.style.display = "none";
        jsonPreviewDOM.textContent = "";
        dataLengthDOM.textContent = "0";
        dataSizeDOM.textContent = "0";
      })

      // const sendButton = document.getElementById('sendRequest');
      // const progressFill = document.getElementById('progressFill');
      // const statusDiv = document.getElementById('status');
      // const resultDiv = document.getElementById('result');

      // sendButton.addEventListener('click', function() {
      //     // é‡ç½®çŠ¶æ€
      //     progressFill.style.width = '0%';
      //     statusDiv.textContent = 'å¼€å§‹è¯·æ±‚...';
      //     resultDiv.style.display = 'none';
      //     sendButton.disabled = true;
      //     sendButton.textContent = 'è¯·æ±‚ä¸­...';

      //     const xhr = new XMLHttpRequest();

      //     // onload äº‹ä»¶å¤„ç†
      //     xhr.onload = function(event) {
      //         sendButton.disabled = false;
      //         sendButton.textContent = 'å‘é€è¯·æ±‚ ';

      //         if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {
      //             statusDiv.textContent = 'âœ… è¯·æ±‚å®Œæˆï¼æ•°æ®æ¥æ”¶å®Œæ¯•';

      //             try {
      //                 const responseData = JSON.parse(xhr.responseText);
      //                 const dataLength = xhr.responseText.length;
      //                 const dataSizeMB = (dataLength / (1024 * 1024)).toFixed(2);
      //                 const arrayLength = responseData.data ? responseData.data.length : 'N/A';

      //                 // æ›´æ–°ç»“æœæ˜¾ç¤º
      //                 document.getElementById('dataLength').textContent = dataLength.toLocaleString();
      //                 document.getElementById('dataSize').textContent = dataSizeMB;
      //                 document.getElementById('arrayLength').textContent = arrayLength.toLocaleString();

      //                 // æ ¼å¼åŒ–JSONé¢„è§ˆ
      //                 const jsonPreview = JSON.stringify(responseData, null, 2).substring(0, 500);
      //                 document.getElementById('jsonPreview').textContent = jsonPreview + '\n...';

      //                 resultDiv.style.display = 'block';
      //             } catch (error) {
      //                 // å¦‚æœJSONè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬
      //                 document.getElementById('dataLength').textContent = xhr.responseText.length.toLocaleString();
      //                 document.getElementById('dataSize').textContent = (xhr.responseText.length / (1024 * 1024)).toFixed(2);
      //                 document.getElementById('arrayLength').textContent = 'è§£æå¤±è´¥';
      //                 document.getElementById('jsonPreview').textContent = xhr.responseText.substring(0, 200) + '...';
      //                 resultDiv.style.display = 'block';
      //             }
      //         } else {
      //             statusDiv.textContent = 'è¯·æ±‚å¤±è´¥: ' + xhr.status + ' ' + xhr.statusText;
      //         }
      //     };

      //     // onprogress äº‹ä»¶å¤„ç† - è¿™å°±æ˜¯Progressäº‹ä»¶çš„é­”åŠ›æ‰€åœ¨ï¼
      //     xhr.onprogress = function(event) {
      //         const statusElement = document.getElementById("status");

      //         if (event.lengthComputable) {
      //             const percentComplete = (event.loaded / event.total) * 100;
      //             progressFill.style.width = percentComplete + '%';

      //             // æ˜¾ç¤ºè¯¦ç»†çš„è¿›åº¦ä¿¡æ¯
      //             const loadedMB = (event.loaded / (1024 * 1024)).toFixed(2);
      //             const totalMB = (event.total / (1024 * 1024)).toFixed(2);

      //             statusElement.innerHTML = `
      //                 <strong>ğŸ“Š ä¸‹è½½è¿›åº¦:</strong> ${percentComplete.toFixed(2)}%<br>
      //                 <strong>ğŸ“¦ æ•°æ®æ¥æ”¶:</strong> ${loadedMB}MB / ${totalMB}MB<br>
      //                 <strong>ğŸ”¢ å­—èŠ‚è¯¦æƒ…:</strong> ${event.loaded.toLocaleString()} / ${event.total.toLocaleString()} å­—èŠ‚
      //             `;
      //         } else {
      //             // å¦‚æœæ— æ³•è®¡ç®—è¿›åº¦ï¼ˆæœåŠ¡å™¨æ²¡æä¾›Content-Lengthï¼‰
      //             const loadedMB = (event.loaded / (1024 * 1024)).toFixed(2);
      //             statusElement.innerHTML = `
      //                 <strong>ğŸ“Š æ­£åœ¨æ¥æ”¶æ•°æ®...</strong><br>
      //                 <strong>ğŸ“¦ å·²æ¥æ”¶:</strong> ${loadedMB}MB (${event.loaded.toLocaleString()} å­—èŠ‚)<br>
      //                 <strong>â„¹ï¸ æ€»å¤§å°æœªçŸ¥</strong> (æœåŠ¡å™¨æœªæä¾›Content-Lengthå¤´)
      //             `;
      //         }
      //     };

      //     // é”™è¯¯å¤„ç†
      //     xhr.onerror = function() {
      //         statusDiv.textContent = 'ç½‘ç»œé”™è¯¯';
      //         sendButton.disabled = false;
      //         sendButton.textContent = 'å‘é€è¯·æ±‚ ';
      //     };

      //     // è¶…æ—¶å¤„ç†
      //     xhr.timeout = 30000; // 30ç§’è¶…æ—¶
      //     xhr.ontimeout = function() {
      //         statusDiv.textContent = 'è¯·æ±‚è¶…æ—¶';
      //         sendButton.disabled = false;
      //         sendButton.textContent = 'å‘é€è¯·æ±‚ ';
      //     };

      //     // å‘é€è¯·æ±‚
      //     xhr.open("GET", "http://127.0.0.1:4523/m1/7590620-7329073-default/xhrStudy/demo01", true);
      //     xhr.send(null);
      // });
    </script>
  </body>
</html>
