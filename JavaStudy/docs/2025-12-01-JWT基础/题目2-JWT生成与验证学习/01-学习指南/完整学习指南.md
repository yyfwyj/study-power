# JWTç¬¬äºŒé¢˜ï¼šå®Œæ•´å­¦ä¹ æŒ‡å—

## ğŸ“š å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬æŒ‡å—çš„å­¦ä¹ ï¼Œä½ å°†æŒæ¡ï¼š

1. **JWT Tokenè¿‡æ»¤å’ŒéªŒè¯** - ç†è§£å¹¶å®ç°JWTè®¤è¯è¿‡æ»¤å™¨
2. **Spring Securityé›†æˆ** - æŒæ¡Spring Securityçš„æ ¸å¿ƒé…ç½®å’Œä½¿ç”¨
3. **ç»Ÿä¸€å“åº”æ ¼å¼** - è®¾è®¡ä¼ä¸šçº§çš„APIå“åº”æ ¼å¼å’Œå¼‚å¸¸å¤„ç†
4. **ä¼ä¸šçº§å¼€å‘å®è·µ** - å­¦ä¹ çœŸå®é¡¹ç›®ä¸­çš„æœ€ä½³å®è·µ

## ğŸ¯ å­¦ä¹ å‰å‡†å¤‡

### 1.1 åŸºç¡€çŸ¥è¯†è¦æ±‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ å·²ç»æŒæ¡ï¼š

- âœ… JavaåŸºç¡€è¯­æ³•
- âœ… Spring BootåŸºç¡€çŸ¥è¯†
- âœ… JWTåŸºæœ¬æ¦‚å¿µï¼ˆé¢˜ç›®1çš„å†…å®¹ï¼‰
- âŒ Spring Securityï¼ˆæœ¬é¢˜ç›®å°†å­¦ä¹ ï¼‰
- âŒ è¿‡æ»¤å™¨æ¨¡å¼ï¼ˆæœ¬é¢˜ç›®å°†å­¦ä¹ ï¼‰
- âŒ ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆæœ¬é¢˜ç›®å°†å­¦ä¹ ï¼‰

### 1.2 å­¦ä¹ ç¯å¢ƒå‡†å¤‡

1. **é¡¹ç›®ç»“æ„ç¡®è®¤**ï¼š
   ```
   JavaStudy/
   â”œâ”€â”€ src/main/java/com/javastudy/V20251201_JWT/
   â”‚   â”œâ”€â”€ question1/          # JWTå·¥å…·ç±»ï¼ˆå·²å®Œæˆï¼‰
   â”‚   â””â”€â”€ question2/          # æœ¬é¢˜ç›®çš„å®ç°ç›®å½•
   â”œâ”€â”€ docs/2025-12-01-JWTåŸºç¡€/
   â”‚   â””â”€â”€ é¢˜ç›®2-JWTç”Ÿæˆä¸éªŒè¯å­¦ä¹ /  # å­¦ä¹ èµ„æ–™ç›®å½•
   ```

2. **ä¾èµ–ç¡®è®¤**ï¼š
   ç¡®ä¿`pom.xml`ä¸­åŒ…å«ï¼š
   ```xml
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-security</artifactId>
   </dependency>
   ```

### 1.3 å­¦ä¹ å¿ƒæ€

- ğŸ” **ä¸è¦æ€¥äºçœ‹ä»£ç ** - å…ˆç†è§£åŸç†ï¼Œå†åŠ¨æ‰‹å®ç°
- ğŸ’¡ **å¤šæ€è€ƒä¸ºä»€ä¹ˆ** - ç†è§£è®¾è®¡æ€è·¯ï¼Œè€Œä¸åªæ˜¯è®°ä½ä»£ç 
- ğŸ§ª **è¾¹å­¦è¾¹æµ‹è¯•** - æ¯ä¸ªæ­¥éª¤å®Œæˆåéƒ½è¦æµ‹è¯•éªŒè¯
- ğŸ“ **è®°å½•ç–‘é—®** - é‡åˆ°é—®é¢˜æ—¶ï¼Œè®°å½•å¹¶æ€è€ƒè§£å†³æ–¹æ¡ˆ

---

## ğŸ“– å­¦ä¹ è·¯å¾„

### ç¬¬ä¸€é˜¶æ®µï¼šç†è§£åŸºç¡€æ¦‚å¿µï¼ˆçº¦2å°æ—¶ï¼‰

#### é˜¶æ®µç›®æ ‡ï¼šå»ºç«‹ç†è®ºåŸºç¡€

#### æ­¥éª¤1ï¼šå­¦ä¹ è¿‡æ»¤å™¨åŸç†
**æ—¶é—´**ï¼š30åˆ†é’Ÿ
**å†…å®¹**ï¼š[ç†è®ºåŸºç¡€-è¿‡æ»¤å™¨ç¯‡](../03-ç†è®ºåŸºç¡€/ç†è®ºåŸºç¡€-è¿‡æ»¤å™¨ç¯‡.md)

**å­¦ä¹ è¦ç‚¹**ï¼š
- ä»€ä¹ˆæ˜¯è¿‡æ»¤å™¨æ¨¡å¼
- Spring Securityè¿‡æ»¤å™¨é“¾çš„å·¥ä½œåŸç†
- ä¸ºä»€ä¹ˆJWTè¿‡æ»¤å™¨è¦ç»§æ‰¿OncePerRequestFilter
- ä¼ä¸šçº§è¿‡æ»¤å™¨è®¾è®¡åŸåˆ™

**æ€è€ƒé—®é¢˜**ï¼š
1. è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
2. ä¸ºä»€ä¹ˆJWTè¿‡æ»¤å™¨è¦æ”¾åœ¨UsernamePasswordAuthenticationFilterä¹‹å‰ï¼Ÿ
3. éªŒè¯å¤±è´¥æ—¶ï¼Œä¸ºä»€ä¹ˆè¦ç»§ç»­æ‰§è¡Œè¿‡æ»¤å™¨é“¾ï¼Ÿ

#### æ­¥éª¤2ï¼šå­¦ä¹ Spring Securityæ ¸å¿ƒæ¦‚å¿µ
**æ—¶é—´**ï¼š45åˆ†é’Ÿ
**å†…å®¹**ï¼š[ç†è®ºåŸºç¡€-SpringSecurityç¯‡](../03-ç†è®ºåŸºç¡€/ç†è®ºåŸºç¡€-SpringSecurityç¯‡.md)

**å­¦ä¹ è¦ç‚¹**ï¼š
- SecurityContextçš„å·¥ä½œåŸç†
- Authenticationå¯¹è±¡çš„ç»„æˆ
- è®¤è¯å’Œæˆæƒçš„åŒºåˆ«
- é…ç½®æ–¹æ³•çš„å«ä¹‰

**æ€è€ƒé—®é¢˜**ï¼š
1. SecurityContextHolderä¸ºä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ
2. UsernamePasswordAuthenticationTokençš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
3. æ— çŠ¶æ€Sessionæ„å‘³ç€ä»€ä¹ˆï¼Ÿ

#### æ­¥éª¤3ï¼šå­¦ä¹ ç»Ÿä¸€å“åº”æ ¼å¼
**æ—¶é—´**ï¼š30åˆ†é’Ÿ
**å†…å®¹**ï¼š[ç†è®ºåŸºç¡€-å“åº”æ ¼å¼ç¯‡](../03-ç†è®ºåŸºç¡€/ç†è®ºåŸºç¡€-å“åº”æ ¼å¼ç¯‡.md)

**å­¦ä¹ è¦ç‚¹**ï¼š
- RESTful APIå“åº”æ ‡å‡†
- HTTPçŠ¶æ€ç çš„ä½¿ç”¨è§„èŒƒ
- ä¸šåŠ¡çŠ¶æ€ç çš„è®¾è®¡åŸåˆ™
- ç»Ÿä¸€å“åº”æ ¼å¼çš„ä¼˜åŠ¿

**æ€è€ƒé—®é¢˜**ï¼š
1. HTTPçŠ¶æ€ç å’Œä¸šåŠ¡çŠ¶æ€ç æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
2. ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€å“åº”æ ¼å¼ï¼Ÿ
3. å¼‚å¸¸ä¿¡æ¯åº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ

#### é˜¶æ®µéªŒè¯
å®Œæˆç†è®ºå­¦ä¹ åï¼Œå›ç­”ä»¥ä¸‹é—®é¢˜ï¼š
- JWTè¿‡æ»¤å™¨åœ¨Spring Securityè¿‡æ»¤å™¨é“¾ä¸­çš„ä½ç½®æ˜¯ä»€ä¹ˆï¼Ÿ
- SecurityContextå­˜å‚¨åœ¨å“ªé‡Œï¼Ÿå¦‚ä½•è·å–ï¼Ÿ
- 401å’Œ403çŠ¶æ€ç åˆ†åˆ«åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨ï¼Ÿ

---

### ç¬¬äºŒé˜¶æ®µï¼šæŒæ¡APIä½¿ç”¨ï¼ˆçº¦3å°æ—¶ï¼‰

#### é˜¶æ®µç›®æ ‡ï¼šå­¦ä¼šä½¿ç”¨å…·ä½“API

#### æ­¥éª¤4ï¼šå­¦ä¹ è¿‡æ»¤å™¨ç›¸å…³API
**æ—¶é—´**ï¼š1å°æ—¶
**å†…å®¹**ï¼š[APIè¯¦è§£-è¿‡æ»¤å™¨ç¯‡](../02-APIè¯¦è§£/APIè¯¦è§£-è¿‡æ»¤å™¨ç¯‡.md)

**å­¦ä¹ è¦ç‚¹**ï¼š
- OncePerRequestFilterçš„ä½¿ç”¨æ–¹æ³•
- HttpServletRequest.getHeader()çš„ä½¿ç”¨
- FilterChain.doFilter()çš„è°ƒç”¨æ—¶æœº
- å®Œæ•´çš„JWTè¿‡æ»¤å™¨å®ç°æµç¨‹

**å®è·µä»»åŠ¡**ï¼š
å°è¯•å†™å‡ºTokenæå–çš„ä»£ç é€»è¾‘ï¼š
```java
// æ€è€ƒï¼šè¿™æ®µä»£ç åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ
// String authHeader = request.getHeader("Authorization");
// if (authHeader != null && authHeader.startsWith("Bearer ")) {
//     String token = authHeader.substring(7);
//     // TODO: éªŒè¯token
// }
```

#### æ­¥éª¤5ï¼šå­¦ä¹ Spring Securityç›¸å…³API
**æ—¶é—´**ï¼š1å°æ—¶
**å†…å®¹**ï¼š[APIè¯¦è§£-SpringSecurityç¯‡](../02-APIè¯¦è§£/APIè¯¦è§£-SpringSecurityç¯‡.md)

**å­¦ä¹ è¦ç‚¹**ï¼š
- SecurityContextHolderçš„ä½¿ç”¨æ–¹æ³•
- UsernamePasswordAuthenticationTokençš„æ„é€ 
- HttpSecurityçš„é…ç½®API
- è¿‡æ»¤å™¨é¡ºåºçš„é…ç½®æ–¹æ³•

**å®è·µä»»åŠ¡**ï¼š
å°è¯•å†™å‡ºåˆ›å»ºè®¤è¯å¯¹è±¡çš„ä»£ç ï¼š
```java
// æ€è€ƒï¼šè¿™æ®µä»£ç åº”è¯¥æ”¾åœ¨éªŒè¯TokenæˆåŠŸå
// Authentication auth = new UsernamePasswordAuthenticationToken(
//     username,           // principal
//     null,              // credentials
//     authorities        // authorities
// );
// SecurityContextHolder.getContext().setAuthentication(auth);
```

#### æ­¥éª¤6ï¼šå­¦ä¹ å“åº”æ ¼å¼ç›¸å…³API
**æ—¶é—´**ï¼š1å°æ—¶
**å†…å®¹**ï¼š[APIè¯¦è§£-å“åº”æ ¼å¼ç¯‡](../02-APIè¯¦è§£/APIè¯¦è§£-å“åº”æ ¼å¼ç¯‡.md)

**å­¦ä¹ è¦ç‚¹**ï¼š
- ResponseEntityçš„ä½¿ç”¨æ–¹æ³•
- @ControllerAdviceçš„ä½¿ç”¨
- HttpStatusæšä¸¾çš„ä½¿ç”¨
- ç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„è®¾è®¡

**å®è·µä»»åŠ¡**ï¼š
å°è¯•è®¾è®¡Resultç±»çš„é™æ€å·¥å‚æ–¹æ³•ï¼š
```java
// æ€è€ƒï¼šå¦‚ä½•è®¾è®¡success()å’Œfail()æ–¹æ³•ï¼Ÿ
// public static <T> Result<T> success(T data) { ... }
// public static <T> Result<T> fail(Integer code, String message) { ... }
```

#### é˜¶æ®µéªŒè¯
å®ŒæˆAPIå­¦ä¹ åï¼Œèƒ½å¤Ÿï¼š
- è§£é‡ŠOncePerRequestFilterçš„ä½œç”¨å’Œä¼˜åŠ¿
- è¯´å‡ºSecurityContextHolderçš„ä½¿ç”¨åœºæ™¯
- æè¿°HttpSecurityçš„ä¸»è¦é…ç½®æ–¹æ³•

---

### ç¬¬ä¸‰é˜¶æ®µï¼šåŠ¨æ‰‹å®ç°ï¼ˆçº¦4å°æ—¶ï¼‰

#### é˜¶æ®µç›®æ ‡ï¼šè‡ªå·±å®ç°å®Œæ•´åŠŸèƒ½

#### æ­¥éª¤7ï¼šå®ç°JWTè®¤è¯è¿‡æ»¤å™¨
**æ—¶é—´**ï¼š2å°æ—¶
**æ¡†æ¶æ–‡ä»¶**ï¼š`src/main/java/com/javastudy/V20251201_JWT/question2/JwtAuthenticationFilter.java`

**å®ç°è¦ç‚¹**ï¼š

1. **ç»§æ‰¿OncePerRequestFilter**
   ```java
   public class JwtAuthenticationFilter extends OncePerRequestFilter {
       // TODO: å®ç°è¿‡æ»¤å™¨é€»è¾‘
   }
   ```

2. **å®ç°shouldNotFilter()æ–¹æ³•**
   - è·³è¿‡å…¬å¼€è·¯å¾„
   - è·³è¿‡OPTIONSè¯·æ±‚
   - æ€è€ƒï¼šå“ªäº›è·¯å¾„ä¸éœ€è¦JWTéªŒè¯ï¼Ÿ

3. **å®ç°doFilterInternal()æ–¹æ³•**
   - æå–Token
   - éªŒè¯Token
   - è®¾ç½®è®¤è¯ä¿¡æ¯
   - ç»§ç»­è¿‡æ»¤å™¨é“¾

4. **å®ç°è¾…åŠ©æ–¹æ³•**
   - extractToken()ï¼šæå–Token
   - getAuthoritiesFromToken()ï¼šè·å–æƒé™

**å…³é”®ä»£ç ä½ç½®**ï¼š
```java
// ä½ç½®1ï¼šTokenæå–
String token = extractToken(request);

// ä½ç½®2ï¼šTokenéªŒè¯
String username = jwtUtil.getUsernameFromToken(token);

// ä½ç½®3ï¼šåˆ›å»ºè®¤è¯å¯¹è±¡
Authentication auth = new UsernamePasswordAuthenticationToken(
    username, null, authorities
);

// ä½ç½®4ï¼šè®¾ç½®åˆ°SecurityContext
SecurityContextHolder.getContext().setAuthentication(auth);

// ä½ç½®5ï¼šç»§ç»­è¿‡æ»¤å™¨é“¾
filterChain.doFilter(request, response);
```

#### æ­¥éª¤8ï¼šé…ç½®Spring Security
**æ—¶é—´**ï¼š1å°æ—¶
**æ¡†æ¶æ–‡ä»¶**ï¼š`src/main/java/com/javastudy/V20251201_JWT/question2/config/SecurityConfig.java`

**å®ç°è¦ç‚¹**ï¼š

1. **ç¦ç”¨CSRF**
   ```java
   http.csrf().disable();
   ```

2. **é…ç½®æ— çŠ¶æ€Session**
   ```java
   http.sessionManagement()
       .sessionCreationPolicy(SessionCreationPolicy.STATELESS);
   ```

3. **é…ç½®è·¯å¾„æˆæƒ**
   ```java
   http.authorizeRequests()
       .antMatchers("/api/public/**").permitAll()
       .antMatchers("/api/**").authenticated();
   ```

4. **æ·»åŠ JWTè¿‡æ»¤å™¨**
   ```java
   http.addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);
   ```

**æ€è€ƒé—®é¢˜**ï¼š
- ä¸ºä»€ä¹ˆéœ€è¦ç¦ç”¨CSRFï¼Ÿ
- æ— çŠ¶æ€Sessionçš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ
- è¿‡æ»¤å™¨é¡ºåºä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ

#### æ­¥éª¤9ï¼šå®ç°ç»Ÿä¸€å“åº”æ ¼å¼
**æ—¶é—´**ï¼š1å°æ—¶
**æ¡†æ¶æ–‡ä»¶**ï¼š`src/main/java/com/javastudy/V20251201_JWT/question2/common/Result.java`

**å®ç°è¦ç‚¹**ï¼š

1. **è®¾è®¡Resultç±»ç»“æ„**
   ```java
   public class Result<T> {
       private Integer code;
       private String message;
       private T data;
       private Long timestamp;
   }
   ```

2. **å®ç°é™æ€å·¥å‚æ–¹æ³•**
   ```java
   public static <T> Result<T> success(T data) { ... }
   public static <T> Result<T> fail(Integer code, String message) { ... }
   ```

3. **ç†è§£æ³›å‹çš„ä½¿ç”¨**
   - `Result<User>` è¡¨ç¤ºdataæ˜¯Userç±»å‹
   - `Result<Void>` è¡¨ç¤ºæ— æ•°æ®è¿”å›

#### æ­¥éª¤10ï¼šå®ç°æµ‹è¯•æ¥å£
**æ—¶é—´**ï¼š1å°æ—¶
**æ¡†æ¶æ–‡ä»¶**ï¼š`src/main/java/com/javastudy/V20251201_JWT/question2/controller/AuthController.java`

**å®ç°è¦ç‚¹**ï¼š

1. **ç™»å½•æ¥å£**
   - æ¥æ”¶ç”¨æˆ·åå¯†ç 
   - ç”ŸæˆJWT Token
   - è¿”å›ç»Ÿä¸€æ ¼å¼å“åº”

2. **ç”¨æˆ·ä¿¡æ¯æ¥å£**
   - è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
   - ä½¿ç”¨SecurityContextHolder
   - éªŒè¯JWTè¿‡æ»¤å™¨æ˜¯å¦å·¥ä½œ

3. **å…¬å¼€æ¥å£**
   - æ— éœ€è®¤è¯å³å¯è®¿é—®
   - éªŒè¯SecurityConfigé…ç½®æ˜¯å¦æ­£ç¡®

**å…³é”®ä»£ç **ï¼š
```java
// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
Authentication auth = SecurityContextHolder.getContext().getAuthentication();
String username = auth.getName();

// è¿”å›ç»Ÿä¸€æ ¼å¼
return Result.success(userInfo);
```

#### é˜¶æ®µéªŒè¯
å®Œæˆå®ç°åï¼Œå¯åŠ¨åº”ç”¨æµ‹è¯•ï¼š
- å…¬å¼€æ¥å£å¯ä»¥è®¿é—®
- å—ä¿æŠ¤æ¥å£éœ€è¦Token
- æä¾›æœ‰æ•ˆTokenå¯ä»¥è®¿é—®
- æä¾›æ— æ•ˆTokenè¿”å›401

---

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•éªŒè¯ï¼ˆçº¦1å°æ—¶ï¼‰

#### é˜¶æ®µç›®æ ‡ï¼šéªŒè¯åŠŸèƒ½æ­£ç¡®æ€§

#### æ­¥éª¤11ï¼šå­¦ä¹ æµ‹è¯•åœºæ™¯
**æ—¶é—´**ï¼š30åˆ†é’Ÿ
**å†…å®¹**ï¼š[æµ‹è¯•åœºæ™¯ä¸éªŒè¯](../04-æµ‹è¯•éªŒè¯/æµ‹è¯•åœºæ™¯ä¸éªŒè¯.md)

**æµ‹è¯•è¦ç‚¹**ï¼š
1. ç™»å½•è·å–Token
2. ä½¿ç”¨æœ‰æ•ˆTokenè®¿é—®
3. ä½¿ç”¨æ— æ•ˆTokenè®¿é—®
4. ä¸ä½¿ç”¨Tokenè®¿é—®
5. è®¿é—®å…¬å¼€æ¥å£

#### æ­¥éª¤12ï¼šå®é™…æµ‹è¯•
**æ—¶é—´**ï¼š30åˆ†é’Ÿ

**ä½¿ç”¨curlæµ‹è¯•**ï¼š
```bash
# 1. æµ‹è¯•å…¬å¼€æ¥å£
curl http://localhost:8080/api/public/hello

# 2. æµ‹è¯•ç™»å½•
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'

# 3. ä½¿ç”¨Tokenè®¿é—®å—ä¿æŠ¤æ¥å£
curl http://localhost:8080/api/user/info \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… å…¬å¼€æ¥å£ï¼š200 OK
- âœ… ç™»å½•æ¥å£ï¼š200 OK + Token
- âœ… æœ‰Tokenè®¿é—®ï¼š200 OK + ç”¨æˆ·ä¿¡æ¯
- âœ… æ— Tokenè®¿é—®ï¼š401 Unauthorized
- âœ… æ— æ•ˆTokenè®¿é—®ï¼š401 Unauthorized

---

## ğŸ” å…³é”®é—®é¢˜è§£ç­”

### é—®é¢˜1ï¼šä¸ºä»€ä¹ˆéœ€è¦JWTè¿‡æ»¤å™¨ï¼Ÿ

**å›ç­”**ï¼š
ä¼ ç»ŸWebåº”ç”¨ä½¿ç”¨Sessionæ¥ä¿æŒç™»å½•çŠ¶æ€ï¼Œä½†Sessionæœ‰ä»¥ä¸‹é—®é¢˜ï¼š
- æœåŠ¡ç«¯éœ€è¦å­˜å‚¨Sessionæ•°æ®
- å¤šæœåŠ¡å™¨éƒ¨ç½²æ—¶éœ€è¦Sessionå…±äº«
- éš¾ä»¥æ‰©å±•åˆ°ç§»åŠ¨ç«¯

JWTè§£å†³äº†è¿™äº›é—®é¢˜ï¼š
- æ— çŠ¶æ€ï¼šæœåŠ¡ç«¯ä¸éœ€è¦å­˜å‚¨Token
- è‡ªåŒ…å«ï¼šTokenåŒ…å«æ‰€æœ‰å¿…è¦ä¿¡æ¯
- å¯æ‰©å±•ï¼šæ˜“äºåˆ†å¸ƒå¼éƒ¨ç½²

### é—®é¢˜2ï¼šJWTè¿‡æ»¤å™¨çš„å·¥ä½œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**å›ç­”**ï¼š
```
1. è¯·æ±‚åˆ°è¾¾ â†’ 2. JWTè¿‡æ»¤å™¨æ£€æŸ¥Authorizationå¤´
      â†“                      â†“
3. æå–Bearer Token â†’ 4. éªŒè¯Tokenæœ‰æ•ˆæ€§
      â†“                      â†“
5. åˆ›å»ºAuthenticationå¯¹è±¡ â†’ 6. è®¾ç½®åˆ°SecurityContext
      â†“                      â†“
7. ç»§ç»­è¿‡æ»¤å™¨é“¾ â†’ 8. FilterSecurityInterceptoræ£€æŸ¥æƒé™
```

### é—®é¢˜3ï¼šä¸ºä»€ä¹ˆéªŒè¯å¤±è´¥è¦ç»§ç»­è¿‡æ»¤å™¨é“¾ï¼Ÿ

**å›ç­”**ï¼š
å¦‚æœéªŒè¯å¤±è´¥å°±åœæ­¢ï¼Œä¼šå¯¼è‡´ï¼š
- æ— æ³•åˆ°è¾¾å…¶ä»–è¿‡æ»¤å™¨
- æ— æ³•åˆ°è¾¾FilterSecurityInterceptor
- æ— æ³•è¿”å›ç»Ÿä¸€çš„401é”™è¯¯

æ­£ç¡®çš„åšæ³•ï¼š
- éªŒè¯å¤±è´¥æ—¶ï¼Œä¸è®¾ç½®è®¤è¯ä¿¡æ¯
- ç»§ç»­æ‰§è¡Œè¿‡æ»¤å™¨é“¾
- ç”±FilterSecurityInterceptorå‘ç°æ²¡æœ‰è®¤è¯ä¿¡æ¯ï¼Œè¿”å›401

### é—®é¢˜4ï¼šSecurityContextæ˜¯ä»€ä¹ˆï¼Ÿ

**å›ç­”**ï¼š
SecurityContextæ˜¯Spring Securityå­˜å‚¨è®¤è¯ä¿¡æ¯çš„å®¹å™¨ï¼š

- **å­˜å‚¨ä½ç½®**ï¼šThreadLocalï¼ˆæ¯ä¸ªè¯·æ±‚çº¿ç¨‹ç‹¬ç«‹ï¼‰
- **åŒ…å«å†…å®¹**ï¼šAuthenticationå¯¹è±¡
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šè¯·æ±‚å¼€å§‹æ—¶åˆ›å»ºï¼Œè¯·æ±‚ç»“æŸæ—¶æ¸…ç†
- **è·å–æ–¹å¼**ï¼šSecurityContextHolder.getContext()

### é—®é¢˜5ï¼šç»Ÿä¸€å“åº”æ ¼å¼ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ

**å›ç­”**ï¼š
ç»Ÿä¸€å“åº”æ ¼å¼çš„å¥½å¤„ï¼š

1. **å‰ç«¯å‹å¥½**ï¼šç»Ÿä¸€çš„æ•°æ®ç»“æ„ï¼Œä¾¿äºå¤„ç†
2. **é”™è¯¯ä¸€è‡´**ï¼šæ‰€æœ‰é”™è¯¯éƒ½ä½¿ç”¨ç›¸åŒæ ¼å¼
3. **æ‰©å±•æ€§å¥½**ï¼šæ˜“äºæ·»åŠ æ–°å­—æ®µ
4. **æ–‡æ¡£å‹å¥½**ï¼šAPIæ–‡æ¡£æ›´æ¸…æ™°

---

## ğŸ› ï¸ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1ï¼šTokenæ— æ³•éªŒè¯
```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ£€æŸ¥null
String authHeader = request.getHeader("Authorization");
String token = authHeader.substring(7); // NPEé£é™©
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// âœ… æ­£ç¡®ï¼šå®Œæ•´çš„nullæ£€æŸ¥
String authHeader = request.getHeader("Authorization");
if (authHeader != null && authHeader.startsWith("Bearer ")) {
    String token = authHeader.substring(7);
    // éªŒè¯token
}
```

### é”™è¯¯2ï¼šå¿˜è®°è°ƒç”¨filterChain.doFilter()
```java
// âŒ é”™è¯¯ï¼šéªŒè¯æˆåŠŸåå¿˜è®°ç»§ç»­è¿‡æ»¤å™¨é“¾
if (tokenæœ‰æ•ˆ) {
    setAuthentication(token);
    // ç¼ºå°‘ï¼šfilterChain.doFilter(request, response);
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// âœ… æ­£ç¡®ï¼šæ— è®ºéªŒè¯æˆåŠŸå¤±è´¥éƒ½è¦è°ƒç”¨
if (tokenæœ‰æ•ˆ) {
    setAuthentication(token);
}
filterChain.doFilter(request, response); // å¿…é¡»è°ƒç”¨
```

### é”™è¯¯3ï¼šè·¯å¾„é…ç½®é”™è¯¯
```java
// âŒ é”™è¯¯ï¼šè·¯å¾„åŒ¹é…é¡ºåºé”™è¯¯
http.authorizeRequests()
    .antMatchers("/api/**").authenticated()  // å¤ªæ—©åŒ¹é…
    .antMatchers("/api/public/**").permitAll(); // æ°¸è¿œä¸ä¼šæ‰§è¡Œ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// âœ… æ­£ç¡®ï¼šå…·ä½“è·¯å¾„åœ¨å‰ï¼Œé€šé…è·¯å¾„åœ¨å
http.authorizeRequests()
    .antMatchers("/api/public/**").permitAll()
    .antMatchers("/api/**").authenticated();
```

### é”™è¯¯4ï¼šSecurityContextè®¾ç½®é”™è¯¯
```java
// âŒ é”™è¯¯ï¼šå¿˜è®°è®¾ç½®authenticatedä¸ºtrue
Authentication auth = new UsernamePasswordAuthenticationToken(
    username, null, authorities
);
// ç¼ºå°‘ï¼šauth.setAuthenticated(true);
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// âœ… æ­£ç¡®ï¼šè®¾ç½®è®¤è¯çŠ¶æ€
Authentication auth = new UsernamePasswordAuthenticationToken(
    username, null, authorities
);
auth.setAuthenticated(true);
SecurityContextHolder.getContext().setAuthentication(auth);
```

---

## ğŸ“Š å­¦ä¹ è¿›åº¦æ£€æŸ¥

### åŸºç¡€çŸ¥è¯†ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰
- [ ] ç†è§£è¿‡æ»¤å™¨æ¨¡å¼å’ŒSpring Securityè¿‡æ»¤å™¨é“¾
- [ ] æŒæ¡SecurityContextå’ŒAuthenticationçš„æ¦‚å¿µ
- [ ] äº†è§£HTTPçŠ¶æ€ç å’Œç»Ÿä¸€å“åº”æ ¼å¼

### APIæŒæ¡ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
- [ ] ç†Ÿç»ƒä½¿ç”¨OncePerRequestFilter
- [ ] æŒæ¡HttpServletRequest.getHeader()
- [ ] ç†è§£SecurityContextHolderçš„ä½¿ç”¨
- [ ] å­¦ä¼šHttpSecurityçš„é…ç½®

### å®ç°èƒ½åŠ›ï¼ˆç¬¬ä¸‰é˜¶æ®µï¼‰
- [ ] å®ç°å®Œæ•´çš„JWTè®¤è¯è¿‡æ»¤å™¨
- [ ] é…ç½®Spring Securityå®‰å…¨è§„åˆ™
- [ ] è®¾è®¡ç»Ÿä¸€å“åº”æ ¼å¼ç±»
- [ ] å®ç°æµ‹è¯•æ¥å£

### æµ‹è¯•éªŒè¯ï¼ˆç¬¬å››é˜¶æ®µï¼‰
- [ ] å…¬å¼€æ¥å£å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] ç™»å½•æ¥å£è¿”å›æœ‰æ•ˆçš„Token
- [ ] æœ‰æ•ˆTokenå¯ä»¥è®¿é—®å—ä¿æŠ¤æ¥å£
- [ ] æ— æ•ˆTokenè¿”å›401é”™è¯¯

---

## ğŸ¯ å­¦ä¹ æˆæœ

å®Œæˆæœ¬é¢˜ç›®åï¼Œä½ å°†è·å¾—ï¼š

### æŠ€æœ¯èƒ½åŠ›
- âœ… **JWTè®¤è¯è¿‡æ»¤å™¨**ï¼šèƒ½å¤Ÿå®ç°ä¼ä¸šçº§çš„JWTè®¤è¯è¿‡æ»¤å™¨
- âœ… **Spring Securityé…ç½®**ï¼šæŒæ¡Spring Securityçš„æ ¸å¿ƒé…ç½®æ–¹æ³•
- âœ… **ç»Ÿä¸€å“åº”æ ¼å¼**ï¼šè®¾è®¡ç¬¦åˆä¼ä¸šæ ‡å‡†çš„APIå“åº”æ ¼å¼
- âœ… **å¼‚å¸¸å¤„ç†**ï¼šå®ç°ç»Ÿä¸€çš„å…¨å±€å¼‚å¸¸å¤„ç†

### æ¶æ„æ€ç»´
- âœ… **è¿‡æ»¤å™¨é“¾è®¾è®¡**ï¼šç†è§£è¿‡æ»¤å™¨åœ¨ç³»ç»Ÿæ¶æ„ä¸­çš„ä½ç½®å’Œä½œç”¨
- âœ… **å®‰å…¨æ¶æ„**ï¼šæŒæ¡è®¤è¯å’Œæˆæƒçš„å®Œæ•´æµç¨‹
- âœ… **APIè®¾è®¡**ï¼šå­¦ä¼šRESTful APIçš„è®¾è®¡åŸåˆ™
- âœ… **é”™è¯¯å¤„ç†**ï¼šç†è§£å¼‚å¸¸å¤„ç†çš„å±‚æ¬¡å’Œç­–ç•¥

### ä¼ä¸šå®è·µ
- âœ… **ä»£ç è§„èŒƒ**ï¼šç¼–å†™ç¬¦åˆä¼ä¸šæ ‡å‡†çš„ä»£ç 
- âœ… **æœ€ä½³å®è·µ**ï¼šæŒæ¡JWTå’ŒSpring Securityçš„æœ€ä½³å®è·µ
- âœ… **é—®é¢˜æ’æŸ¥**ï¼šèƒ½å¤Ÿå¿«é€Ÿå®šä½å’Œè§£å†³å®‰å…¨ç›¸å…³é—®é¢˜
- âœ… **æ‰©å±•æ€§è®¾è®¡**ï¼šè®¾è®¡å¯æ‰©å±•çš„å®‰å…¨æ¶æ„

---

## ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ 

å®ŒæˆJWTç¬¬äºŒé¢˜åï¼Œå»ºè®®ç»§ç»­å­¦ä¹ ï¼š

1. **JWTç¬¬ä¸‰é¢˜**ï¼šå®‰å…¨åŠ å›º - å­¦ä¹ CVE-2016-10555æ¼æ´é˜²å¾¡
2. **Spring Cloud**ï¼šå­¦ä¹ å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¤è¯æˆæƒ
3. **OAuth2**ï¼šå­¦ä¹ æ›´å¤æ‚çš„è®¤è¯æˆæƒæ–¹æ¡ˆ
4. **æƒé™ç®¡ç†ç³»ç»Ÿ**ï¼šå­¦ä¹ RBACã€ABACç­‰æƒé™æ¨¡å‹

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœåœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹APIè¯¦è§£**ï¼šæ¯ä¸ªAPIéƒ½æœ‰è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œæ¡ˆä¾‹
2. **å‚è€ƒç†è®ºåŸºç¡€**ï¼šç†è§£åŸç†æœ‰åŠ©äºè§£å†³é—®é¢˜
3. **æŸ¥çœ‹æµ‹è¯•åœºæ™¯**ï¼šæµ‹è¯•åœºæ™¯åŒ…å«å¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ
4. **é‡æ–°å®¡è§†æ¡†æ¶ä»£ç **ï¼šæ¡†æ¶ä»£ç åŒ…å«è¯¦ç»†çš„TODOæç¤º

---

*å­¦ä¹ æŒ‡å—ç‰ˆæœ¬ï¼š1.0*
*æœ€åæ›´æ–°ï¼š2025å¹´12æœˆ2æ—¥*
*é¢„è®¡å­¦ä¹ æ—¶é•¿ï¼š10å°æ—¶*

