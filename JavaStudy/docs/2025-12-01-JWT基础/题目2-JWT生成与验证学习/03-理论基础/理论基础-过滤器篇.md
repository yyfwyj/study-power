# ç†è®ºåŸºç¡€ï¼šè¿‡æ»¤å™¨åŸç†ä¸è®¾è®¡

## ğŸ“– ç›®å½•

- [1. è¿‡æ»¤å™¨æ¨¡å¼æ¦‚è¿°](#1-è¿‡æ»¤å™¨æ¨¡å¼æ¦‚è¿°)
- [2. Servletè¿‡æ»¤å™¨åŸºç¡€](#2-servletè¿‡æ»¤å™¨åŸºç¡€)
- [3. Spring Securityè¿‡æ»¤å™¨é“¾](#3-spring-securityè¿‡æ»¤å™¨é“¾)
- [4. ä¼ä¸šçº§è¿‡æ»¤å™¨è®¾è®¡åŸåˆ™](#4-ä¼ä¸šçº§è¿‡æ»¤å™¨è®¾è®¡åŸåˆ™)

---

## 1. è¿‡æ»¤å™¨æ¨¡å¼æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯è¿‡æ»¤å™¨æ¨¡å¼

**è¿‡æ»¤å™¨æ¨¡å¼ï¼ˆFilter Patternï¼‰** æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå…è®¸ä½ åœ¨è¯·æ±‚åˆ°è¾¾ç›®æ ‡èµ„æºä¹‹å‰æˆ–ä¹‹åæ‰§è¡ŒæŸäº›æ“ä½œã€‚å°±åƒç°å®ä¸­çš„è¿‡æ»¤ç½‘ï¼Œè¿‡æ»¤å™¨å¯ä»¥ï¼š

- **æ‹¦æˆªè¯·æ±‚**ï¼šåœ¨è¯·æ±‚åˆ°è¾¾æ§åˆ¶å™¨ä¹‹å‰è¿›è¡Œæ£€æŸ¥
- **å¤„ç†è¯·æ±‚**ï¼šå¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹ã€éªŒè¯ã€è®°å½•ç­‰æ“ä½œ
- **å†³å®šæ˜¯å¦ç»§ç»­**ï¼šå¯ä»¥é€‰æ‹©ç»§ç»­ä¼ é€’è¯·æ±‚ï¼Œæˆ–è€…é˜»æ­¢è¯·æ±‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¿‡æ»¤å™¨

åœ¨Webåº”ç”¨ä¸­ï¼Œå¾ˆå¤šåŠŸèƒ½éœ€è¦åœ¨æ¯ä¸ªè¯·æ±‚ä¸­éƒ½æ‰§è¡Œï¼Œä¾‹å¦‚ï¼š

- **èº«ä»½è®¤è¯**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
- **æƒé™éªŒè¯**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®èµ„æº
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ¯ä¸ªè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- **å­—ç¬¦ç¼–ç **ï¼šç»Ÿä¸€å¤„ç†è¯·æ±‚çš„ç¼–ç é—®é¢˜
- **è·¨åŸŸå¤„ç†**ï¼šå¤„ç†CORSç›¸å…³é—®é¢˜

å¦‚æœæŠŠè¿™äº›é€»è¾‘å†™åœ¨æ¯ä¸ªControllerä¸­ï¼Œä¼šå¯¼è‡´ï¼š
- **ä»£ç é‡å¤**ï¼šåŒæ ·çš„ä»£ç å‡ºç°åœ¨å¤šä¸ªåœ°æ–¹
- **éš¾ä»¥ç»´æŠ¤**ï¼šä¿®æ”¹é€»è¾‘éœ€è¦æ”¹å¾ˆå¤šåœ°æ–¹
- **èŒè´£æ··ä¹±**ï¼šControlleråº”è¯¥ä¸“æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œä¸åº”è¯¥å¤„ç†è¿™äº›æ¨ªåˆ‡å…³æ³¨ç‚¹

**è¿‡æ»¤å™¨çš„ä¼˜åŠ¿**ï¼š
- âœ… **é›†ä¸­å¤„ç†**ï¼šæ‰€æœ‰è¯·æ±‚çš„ç»Ÿä¸€å¤„ç†é€»è¾‘éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹
- âœ… **è§£è€¦**ï¼šä¸šåŠ¡ä»£ç å’Œæ¨ªåˆ‡å…³æ³¨ç‚¹åˆ†ç¦»
- âœ… **å¯é…ç½®**ï¼šå¯ä»¥çµæ´»é…ç½®å“ªäº›è¯·æ±‚éœ€è¦ç»è¿‡è¿‡æ»¤å™¨
- âœ… **å¯é‡ç”¨**ï¼šä¸€ä¸ªè¿‡æ»¤å™¨å¯ä»¥åœ¨å¤šä¸ªé¡¹ç›®ä¸­ä½¿ç”¨

### 1.3 è¿‡æ»¤å™¨çš„å·¥ä½œæµç¨‹

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
Filter 1 (ä¾‹å¦‚ï¼šå­—ç¬¦ç¼–ç è¿‡æ»¤å™¨)
    â†“
Filter 2 (ä¾‹å¦‚ï¼šJWTè®¤è¯è¿‡æ»¤å™¨)
    â†“
Filter 3 (ä¾‹å¦‚ï¼šæ—¥å¿—è®°å½•è¿‡æ»¤å™¨)
    â†“
DispatcherServlet (Spring MVC)
    â†“
Controller (ä¸šåŠ¡é€»è¾‘)
    â†“
è¿”å›å“åº”
    â†“
Filter 3 (è¿”å›æ—¶å†æ¬¡æ‰§è¡Œ)
    â†“
Filter 2 (è¿”å›æ—¶å†æ¬¡æ‰§è¡Œ)
    â†“
Filter 1 (è¿”å›æ—¶å†æ¬¡æ‰§è¡Œ)
    â†“
å“åº”è¿”å›å®¢æˆ·ç«¯
```

**å…³é”®ç‚¹**ï¼š
- è¿‡æ»¤å™¨å½¢æˆä¸€æ¡é“¾ï¼ˆFilter Chainï¼‰
- è¯·æ±‚å’Œå“åº”éƒ½ä¼šç»è¿‡è¿‡æ»¤å™¨
- æ¯ä¸ªè¿‡æ»¤å™¨å¯ä»¥å†³å®šæ˜¯å¦ç»§ç»­ä¼ é€’è¯·æ±‚

---

## 2. Servletè¿‡æ»¤å™¨åŸºç¡€

### 2.1 Filteræ¥å£

åœ¨Java Servletè§„èŒƒä¸­ï¼Œè¿‡æ»¤å™¨éœ€è¦å®ç° `javax.servlet.Filter` æ¥å£ï¼š

```java
public interface Filter {
    // åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿‡æ»¤å™¨å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡
    void init(FilterConfig filterConfig) throws ServletException;
    
    // æ ¸å¿ƒæ–¹æ³•ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šè°ƒç”¨
    void doFilter(ServletRequest request, ServletResponse response, 
                  FilterChain chain) throws IOException, ServletException;
    
    // é”€æ¯æ–¹æ³•ï¼Œè¿‡æ»¤å™¨åœæ­¢æ—¶è°ƒç”¨ä¸€æ¬¡
    void destroy();
}
```

**æ–¹æ³•è¯´æ˜**ï¼š

1. **init()** - åˆå§‹åŒ–
   - åœ¨è¿‡æ»¤å™¨åˆ›å»ºæ—¶è°ƒç”¨ä¸€æ¬¡
   - é€šå¸¸ç”¨äºåŠ è½½é…ç½®ã€åˆå§‹åŒ–èµ„æº
   - æ³¨æ„ï¼šåœ¨Springç¯å¢ƒä¸­ï¼Œé€šå¸¸ä½¿ç”¨æ„é€ å‡½æ•°æˆ–@PostConstruct

2. **doFilter()** - æ ¸å¿ƒé€»è¾‘
   - æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè°ƒç”¨
   - å¯ä»¥å¤„ç†è¯·æ±‚å’Œå“åº”
   - **å¿…é¡»è°ƒç”¨** `chain.doFilter()` æ‰èƒ½ç»§ç»­ä¼ é€’è¯·æ±‚

3. **destroy()** - æ¸…ç†èµ„æº
   - åœ¨è¿‡æ»¤å™¨é”€æ¯æ—¶è°ƒç”¨ä¸€æ¬¡
   - ç”¨äºé‡Šæ”¾èµ„æº

### 2.2 åŸºç¡€è¿‡æ»¤å™¨ç¤ºä¾‹

```java
public class SimpleFilter implements Filter {
    
    @Override
    public void init(FilterConfig filterConfig) {
        System.out.println("è¿‡æ»¤å™¨åˆå§‹åŒ–");
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                         FilterChain chain) throws IOException, ServletException {
        System.out.println("è¯·æ±‚è¿›å…¥è¿‡æ»¤å™¨");
        
        // å¤„ç†è¯·æ±‚ï¼ˆåœ¨ä¼ é€’ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ä¹‹å‰ï¼‰
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        String uri = httpRequest.getRequestURI();
        System.out.println("è¯·æ±‚URI: " + uri);
        
        // å¿…é¡»è°ƒç”¨chain.doFilter()ï¼Œå¦åˆ™è¯·æ±‚ä¼šè¢«æ‹¦æˆª
        chain.doFilter(request, response);
        
        // å¤„ç†å“åº”ï¼ˆåœ¨å“åº”è¿”å›ä¹‹å‰ï¼‰
        System.out.println("å“åº”è¿”å›è¿‡æ»¤å™¨");
    }
    
    @Override
    public void destroy() {
        System.out.println("è¿‡æ»¤å™¨é”€æ¯");
    }
}
```

**å…³é”®ç‚¹**ï¼š
- `chain.doFilter()` æ˜¯å…³é”®ï¼š**ä¸è°ƒç”¨åˆ™è¯·æ±‚è¢«æ‹¦æˆª**
- è°ƒç”¨ `chain.doFilter()` **ä¹‹å‰**çš„ä»£ç å¤„ç†è¯·æ±‚
- è°ƒç”¨ `chain.doFilter()` **ä¹‹å**çš„ä»£ç å¤„ç†å“åº”

### 2.3 è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº

è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºå–å†³äºé…ç½®é¡ºåºï¼š

```java
// Filter 1 å…ˆæ‰§è¡Œ
// Filter 2 ç¬¬äºŒä¸ªæ‰§è¡Œ
// Filter 3 æœ€åæ‰§è¡Œ
```

**è¯·æ±‚æµç¨‹**ï¼š
```
è¯·æ±‚ â†’ Filter1 â†’ Filter2 â†’ Filter3 â†’ Controller
å“åº” â† Filter1 â† Filter2 â† Filter3 â† Controller
```

---

## 3. Spring Securityè¿‡æ»¤å™¨é“¾

### 3.1 ä»€ä¹ˆæ˜¯è¿‡æ»¤å™¨é“¾

Spring Securityä½¿ç”¨**è¿‡æ»¤å™¨é“¾ï¼ˆFilter Chainï¼‰**æ¥å®ç°å®‰å…¨åŠŸèƒ½ã€‚å®ƒä¸æ˜¯å•ä¸ªè¿‡æ»¤å™¨ï¼Œè€Œæ˜¯ä¸€ç³»åˆ—æŒ‰é¡ºåºæ‰§è¡Œçš„è¿‡æ»¤å™¨ï¼Œæ¯ä¸ªè¿‡æ»¤å™¨è´Ÿè´£ä¸åŒçš„å®‰å…¨åŠŸèƒ½ã€‚

### 3.2 Spring Securityè¿‡æ»¤å™¨é“¾çš„å®Œæ•´æµç¨‹

Spring Securityçš„è¿‡æ»¤å™¨é“¾åŒ…å«å¤šä¸ªæ ‡å‡†è¿‡æ»¤å™¨ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

```
1. DisableEncodeUrlFilter          # ç¦ç”¨URLç¼–ç 
2. WebAsyncManagerIntegrationFilter # å¼‚æ­¥æ”¯æŒ
3. SecurityContextPersistenceFilter # ä¿å­˜SecurityContext
4. HeaderWriterFilter              # æ·»åŠ å®‰å…¨å“åº”å¤´
5. CsrfFilter                      # CSRFä¿æŠ¤
6. LogoutFilter                    # å¤„ç†ç™»å‡ºè¯·æ±‚
7. UsernamePasswordAuthenticationFilter  # è¡¨å•ç™»å½•è®¤è¯
8. DefaultLoginPageGeneratingFilter     # ç”Ÿæˆé»˜è®¤ç™»å½•é¡µ
9. BasicAuthenticationFilter            # HTTP Basicè®¤è¯
10. RequestCacheAwareFilter            # è¯·æ±‚ç¼“å­˜
11. SecurityContextHolderAwareRequestFilter # åŒ…è£…è¯·æ±‚
12. AnonymousAuthenticationFilter        # åŒ¿åç”¨æˆ·å¤„ç†
13. SessionManagementFilter            # ä¼šè¯ç®¡ç†
14. ExceptionTranslationFilter         # å¼‚å¸¸å¤„ç†
15. FilterSecurityInterceptor          # æƒé™æ£€æŸ¥ï¼ˆæœ€åä¸€ä¸ªï¼‰
```

**å…³é”®è¿‡æ»¤å™¨è¯´æ˜**ï¼š

1. **SecurityContextPersistenceFilter** (ç¬¬3ä¸ª)
   - ä½œç”¨ï¼šåœ¨è¯·æ±‚å¼€å§‹æ—¶ä»Sessionä¸­åŠ è½½SecurityContextï¼Œè¯·æ±‚ç»“æŸæ—¶ä¿å­˜
   - æ—¶æœºï¼šæœ€æ—©æ‰§è¡Œï¼Œç¡®ä¿åç»­è¿‡æ»¤å™¨å¯ä»¥ä½¿ç”¨SecurityContext

2. **UsernamePasswordAuthenticationFilter** (ç¬¬7ä¸ª)
   - ä½œç”¨ï¼šå¤„ç†è¡¨å•ç™»å½•ï¼ŒéªŒè¯ç”¨æˆ·åå¯†ç 
   - æ—¶æœºï¼šåœ¨å¤„ç†ç™»å½•è¯·æ±‚æ—¶æ‰§è¡Œ

3. **AnonymousAuthenticationFilter** (ç¬¬12ä¸ª)
   - ä½œç”¨ï¼šå¦‚æœç”¨æˆ·æœªè®¤è¯ï¼Œåˆ›å»ºä¸€ä¸ªåŒ¿åè®¤è¯å¯¹è±¡
   - åŸå› ï¼šä¿è¯SecurityContextä¸­æ€»æ˜¯æœ‰Authenticationå¯¹è±¡ï¼Œç®€åŒ–åç»­å¤„ç†

4. **FilterSecurityInterceptor** (ç¬¬15ä¸ªï¼Œæœ€åä¸€ä¸ª)
   - ä½œç”¨ï¼šæœ€ç»ˆçš„æƒé™æ£€æŸ¥ï¼Œå†³å®šæ˜¯å¦å…è®¸è®¿é—®èµ„æº
   - æ—¶æœºï¼šåœ¨æ‰€æœ‰å…¶ä»–è¿‡æ»¤å™¨ä¹‹åæ‰§è¡Œ

### 3.3 è‡ªå®šä¹‰è¿‡æ»¤å™¨åº”è¯¥æ”¾åœ¨å“ªé‡Œ

å¯¹äºJWTè®¤è¯è¿‡æ»¤å™¨ï¼Œé€šå¸¸æ”¾åœ¨ï¼š

- **UsernamePasswordAuthenticationFilterä¹‹å‰**
  - åŸå› ï¼šJWTæ˜¯æ— çŠ¶æ€è®¤è¯ï¼Œä¸éœ€è¦è¡¨å•ç™»å½•ï¼Œåº”è¯¥åœ¨è¡¨å•ç™»å½•ä¹‹å‰å°è¯•JWTè®¤è¯
  - å¥½å¤„ï¼šå¦‚æœJWTè®¤è¯æˆåŠŸï¼Œå°±è·³è¿‡è¡¨å•ç™»å½•

**æ¨èä½ç½®**ï¼š
```
...å‰é¢æ ‡å‡†è¿‡æ»¤å™¨...
SecurityContextPersistenceFilter
HeaderWriterFilter
CsrfFilter
LogoutFilter
[JwtAuthenticationFilter] â† æ”¾åœ¨è¿™é‡Œ
UsernamePasswordAuthenticationFilter
...åç»­è¿‡æ»¤å™¨...
```

### 3.4 SecurityContextçš„æµè½¬

ç†è§£SecurityContextçš„æµè½¬éå¸¸é‡è¦ï¼š

```
1. è¯·æ±‚åˆ°è¾¾
   â†“
2. SecurityContextPersistenceFilterä»SessionåŠ è½½SecurityContextï¼ˆå¦‚æœæœ‰ï¼‰
   â†“
3. SecurityContextå¯èƒ½ä¸ºç©ºï¼Œä¹Ÿå¯èƒ½åŒ…å«ä¹‹å‰çš„è®¤è¯ä¿¡æ¯
   â†“
4. JwtAuthenticationFilteræ‰§è¡Œï¼š
   - æå–Token
   - éªŒè¯Token
   - å¦‚æœæœ‰æ•ˆï¼Œåˆ›å»ºAuthenticationå¯¹è±¡
   - è®¾ç½®åˆ°SecurityContext: SecurityContextHolder.getContext().setAuthentication(...)
   â†“
5. åç»­è¿‡æ»¤å™¨å¯ä»¥ä½¿ç”¨SecurityContextä¸­çš„è®¤è¯ä¿¡æ¯
   â†“
6. FilterSecurityInterceptoræ£€æŸ¥æƒé™
   â†“
7. è¯·æ±‚ç»“æŸï¼ŒSecurityContextPersistenceFilterä¿å­˜SecurityContextåˆ°Sessionï¼ˆå¦‚æœä½¿ç”¨Sessionï¼‰
```

**å…³é”®ç†è§£**ï¼š
- SecurityContextæ˜¯**çº¿ç¨‹å±€éƒ¨å˜é‡**ï¼ˆThreadLocalï¼‰ï¼Œæ¯ä¸ªè¯·æ±‚çº¿ç¨‹æœ‰ç‹¬ç«‹çš„SecurityContext
- è®¾ç½®åˆ°SecurityContextçš„è®¤è¯ä¿¡æ¯ï¼Œåç»­è¿‡æ»¤å™¨éƒ½å¯ä»¥è®¿é—®
- å¦‚æœSecurityContextä¸­æ²¡æœ‰è®¤è¯ä¿¡æ¯ï¼ŒFilterSecurityInterceptorä¼šæ‹’ç»è®¿é—®

---

## 4. ä¼ä¸šçº§è¿‡æ»¤å™¨è®¾è®¡åŸåˆ™

### 4.1 å•ä¸€èŒè´£åŸåˆ™

**æ¯ä¸ªè¿‡æ»¤å™¨åªåšä¸€ä»¶äº‹**ï¼š

- âœ… **JWTè¿‡æ»¤å™¨**ï¼šåªè´Ÿè´£æå–å’ŒéªŒè¯JWT Token
- âŒ **ä¸è¦**ï¼šåœ¨JWTè¿‡æ»¤å™¨ä¸­å¤„ç†ä¸šåŠ¡é€»è¾‘ã€è®°å½•è¯¦ç»†æ—¥å¿—ã€å¤„ç†å¼‚å¸¸å“åº”ç­‰

**ä¸ºä»€ä¹ˆ**ï¼š
- èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- å¯ä»¥çµæ´»ç»„åˆä¸åŒçš„è¿‡æ»¤å™¨
- æ˜“äºæµ‹è¯•å’Œè°ƒè¯•

### 4.2 ä¼˜é›…å¤±è´¥åŸåˆ™

**éªŒè¯å¤±è´¥æ—¶ï¼Œä¸è¦æŠ›å‡ºå¼‚å¸¸ï¼Œä¸è¦ä¸­æ–­è¿‡æ»¤å™¨é“¾**ï¼š

```java
// âœ… æ­£ç¡®åšæ³•
if (tokenæ— æ•ˆ) {
    // ä¸è®¾ç½®è®¤è¯ä¿¡æ¯ï¼Œç»§ç»­æ‰§è¡Œè¿‡æ»¤å™¨é“¾
    // è®©FilterSecurityInterceptorå¤„ç†ï¼ˆè¿”å›401ï¼‰
    chain.doFilter(request, response);
    return;
}

// âŒ é”™è¯¯åšæ³•
if (tokenæ— æ•ˆ) {
    throw new AuthenticationException("Tokenæ— æ•ˆ"); // ä¸è¦è¿™æ ·åš
    // æˆ–è€…
    response.sendError(401); // ä¸è¦åœ¨è¿™é‡Œç›´æ¥è¿”å›
    return; // è¿™æ ·ä¼šä¸­æ–­è¿‡æ»¤å™¨é“¾
}
```

**ä¸ºä»€ä¹ˆ**ï¼š
- Spring Securityæœ‰ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- è®©FilterSecurityInterceptorç»Ÿä¸€å¤„ç†æœªè®¤è¯çš„æƒ…å†µ
- ä¿æŒè¿‡æ»¤å™¨é“¾çš„å®Œæ•´æ€§

### 4.3 æ€§èƒ½ä¼˜åŒ–åŸåˆ™

**ä½¿ç”¨OncePerRequestFilter**ï¼š

```java
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    // ...
}
```

**OncePerRequestFilterçš„ä¼˜åŠ¿**ï¼š
- âœ… ç¡®ä¿æ¯ä¸ªè¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡ï¼ˆå³ä½¿æœ‰forwardæˆ–includeï¼‰
- âœ… é¿å…é‡å¤æ‰§è¡Œå¯¼è‡´çš„é—®é¢˜ï¼ˆå¦‚é‡å¤éªŒè¯Tokenï¼‰
- âœ… æ€§èƒ½æ›´å¥½

**åœºæ™¯**ï¼š
- å¦‚æœä½¿ç”¨æ™®é€šçš„Filterï¼Œåœ¨forwardæˆ–includeæ—¶å¯èƒ½ä¼šé‡å¤æ‰§è¡Œ
- OncePerRequestFilterå†…éƒ¨ä½¿ç”¨requestå±æ€§æ ‡è®°ï¼Œé¿å…é‡å¤

### 4.4 çº¿ç¨‹å®‰å…¨åŸåˆ™

**æ³¨æ„SecurityContextHolderçš„ä½¿ç”¨**ï¼š

```java
// âœ… æ­£ç¡®ï¼šæ¯ä¸ªè¯·æ±‚çº¿ç¨‹æœ‰ç‹¬ç«‹çš„SecurityContext
SecurityContext context = SecurityContextHolder.getContext();
context.setAuthentication(authentication);

// âŒ é”™è¯¯ï¼šä¸è¦åœ¨ä¸åŒè¯·æ±‚é—´å…±äº«SecurityContext
private static SecurityContext sharedContext; // ä¸è¦è¿™æ ·åš
```

**ä¸ºä»€ä¹ˆ**ï¼š
- SecurityContextHolderä½¿ç”¨ThreadLocalï¼Œå¤©ç„¶çº¿ç¨‹å®‰å…¨
- æ¯ä¸ªè¯·æ±‚çº¿ç¨‹æœ‰ç‹¬ç«‹çš„SecurityContext
- è¯·æ±‚ç»“æŸåï¼Œçº¿ç¨‹æ± å¯èƒ½ä¼šé‡ç”¨çº¿ç¨‹ï¼Œä½†SecurityContextä¼šè¢«æ¸…ç†

### 4.5 å¼‚å¸¸å¤„ç†åŸåˆ™

**è¿‡æ»¤å™¨ä¸­çš„å¼‚å¸¸å¤„ç†**ï¼š

```java
try {
    // éªŒè¯Token
    if (tokenæœ‰æ•ˆ) {
        // è®¾ç½®è®¤è¯ä¿¡æ¯
    }
} catch (Exception e) {
    // è®°å½•æ—¥å¿—ï¼ˆä¸è¦æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼‰
    log.warn("JWTéªŒè¯å¤±è´¥: {}", e.getMessage());
    // ä¸è¦è®¾ç½®è®¤è¯ä¿¡æ¯ï¼Œç»§ç»­æ‰§è¡Œè¿‡æ»¤å™¨é“¾
    // è®©åç»­å¤„ç†ç»Ÿä¸€å¤„ç†å¼‚å¸¸
}
chain.doFilter(request, response);
```

**åŸåˆ™**ï¼š
- âœ… è®°å½•æ—¥å¿—ï¼Œä½†ä¸è¦æ³„éœ²Tokenå†…å®¹
- âœ… ä¸ä¸­æ–­è¿‡æ»¤å™¨é“¾
- âœ… è®©Spring Securityç»Ÿä¸€å¤„ç†å¼‚å¸¸å“åº”

### 4.6 å¯é…ç½®æ€§åŸåˆ™

**ä½¿è¿‡æ»¤å™¨å¯é…ç½®**ï¼š

```java
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    private List<String> excludedPaths = Arrays.asList("/login", "/public");
    
    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        String path = request.getRequestURI();
        return excludedPaths.stream().anyMatch(path::startsWith);
    }
}
```

**å¥½å¤„**ï¼š
- å¯ä»¥é…ç½®å“ªäº›è·¯å¾„ä¸éœ€è¦JWTéªŒè¯
- æé«˜çµæ´»æ€§
- ä¾¿äºæµ‹è¯•

---

## ğŸ“ æ€»ç»“

### å…³é”®è¦ç‚¹

1. **è¿‡æ»¤å™¨æ¨¡å¼**ï¼šç”¨äºåœ¨è¯·æ±‚å¤„ç†å‰åæ‰§è¡Œç»Ÿä¸€é€»è¾‘
2. **è¿‡æ»¤å™¨é“¾**ï¼šå¤šä¸ªè¿‡æ»¤å™¨æŒ‰é¡ºåºæ‰§è¡Œï¼Œå½¢æˆé“¾å¼ç»“æ„
3. **SecurityContext**ï¼šçº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œå­˜å‚¨å½“å‰è¯·æ±‚çš„è®¤è¯ä¿¡æ¯
4. **è¿‡æ»¤å™¨ä½ç½®**ï¼šJWTè¿‡æ»¤å™¨åº”è¯¥æ”¾åœ¨UsernamePasswordAuthenticationFilterä¹‹å‰
5. **è®¾è®¡åŸåˆ™**ï¼šå•ä¸€èŒè´£ã€ä¼˜é›…å¤±è´¥ã€æ€§èƒ½ä¼˜åŒ–ã€çº¿ç¨‹å®‰å…¨

### ä¸‹ä¸€æ­¥å­¦ä¹ 

ç†è§£è¿‡æ»¤å™¨åŸç†åï¼Œæ¥ä¸‹æ¥åº”è¯¥å­¦ä¹ ï¼š

- [APIè¯¦è§£-è¿‡æ»¤å™¨ç¯‡](../02-APIè¯¦è§£/APIè¯¦è§£-è¿‡æ»¤å™¨ç¯‡.md) - æŒæ¡å…·ä½“çš„APIä½¿ç”¨æ–¹æ³•
- [ç†è®ºåŸºç¡€-SpringSecurityç¯‡](./ç†è®ºåŸºç¡€-SpringSecurityç¯‡.md) - æ·±å…¥ç†è§£Spring Securityæ ¸å¿ƒæ¦‚å¿µ

---

*æ–‡æ¡£æ›´æ–°æ—¶é—´ï¼š2025å¹´12æœˆ2æ—¥*
