# 测试场景与验证

## 📖 目录

- [1. 测试准备](#1-测试准备)
- [2. 测试场景](#2-测试场景)
- [3. 使用Postman测试](#3-使用postman测试)
- [4. 使用curl测试](#4-使用curl测试)
- [5. 常见问题排查](#5-常见问题排查)

---

## 1. 测试准备

### 1.1 启动应用

```bash
# 在项目根目录执行
cd JavaStudy
mvn spring-boot:run
```

应用启动后，默认端口为 `8080`，访问地址：`http://localhost:8080`

### 1.2 验证应用启动

访问健康检查接口（如果有）：
```bash
curl http://localhost:8080/api/public/hello
```

预期响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "message": "这是公开接口，不需要Token"
  },
  "timestamp": 1701590400000
}
```

---

## 2. 测试场景

### 场景1：登录接口（获取Token）

**测试目的**：验证登录接口是否正常工作，能否生成Token

**请求信息**：
- **方法**：POST
- **URL**：`http://localhost:8080/api/login`
- **Headers**：
  ```
  Content-Type: application/json
  ```
- **Body**：
  ```json
  {
    "username": "admin",
    "password": "123456"
  }
  ```

**预期响应**：
- **状态码**：200 OK
- **响应体**：
  ```json
  {
    "code": 200,
    "message": "登录成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImV4cCI6MTcwMTY3NzYwMCwiaWF0IjoxNzAxNjcwNDAwfQ..."
    },
    "timestamp": 1701590400000
  }
  ```

**验证点**：
- ✅ 状态码为200
- ✅ 响应包含token字段
- ✅ token不为空

**保存Token**：复制返回的token，后续测试会用到

---

### 场景2：使用有效Token访问受保护接口

**测试目的**：验证JWT过滤器是否能正确验证Token并设置认证信息

**请求信息**：
- **方法**：GET
- **URL**：`http://localhost:8080/api/user/info`
- **Headers**：
  ```
  Authorization: Bearer <你的Token>
  ```
  将`<你的Token>`替换为场景1获取的Token

**预期响应**：
- **状态码**：200 OK
- **响应体**：
  ```json
  {
    "code": 200,
    "message": "success",
    "data": {
      "username": "admin"
    },
    "timestamp": 1701590400000
  }
  ```

**验证点**：
- ✅ 状态码为200
- ✅ 返回的用户名与登录时使用的用户名一致
- ✅ 没有返回401错误

---

### 场景3：不使用Token访问受保护接口

**测试目的**：验证未提供Token时是否正确返回401错误

**请求信息**：
- **方法**：GET
- **URL**：`http://localhost:8080/api/user/info`
- **Headers**：无（不包含Authorization头）

**预期响应**：
- **状态码**：401 Unauthorized
- **响应体**：根据你的异常处理配置，可能是：
  ```json
  {
    "code": 401,
    "message": "未登录或Token已过期",
    "data": null,
    "timestamp": 1701590400000
  }
  ```

**验证点**：
- ✅ 状态码为401
- ✅ 返回错误信息

---

### 场景4：使用无效Token访问受保护接口

**测试目的**：验证Token无效时是否正确返回401错误

**请求信息**：
- **方法**：GET
- **URL**：`http://localhost:8080/api/user/info`
- **Headers**：
  ```
  Authorization: Bearer invalid_token_12345
  ```

**预期响应**：
- **状态码**：401 Unauthorized
- **响应体**：
  ```json
  {
    "code": 401,
    "message": "Token无效",
    "data": null,
    "timestamp": 1701590400000
  }
  ```

**验证点**：
- ✅ 状态码为401
- ✅ 返回错误信息

---

### 场景5：使用过期Token访问受保护接口

**测试目的**：验证Token过期时是否正确返回401错误

**步骤**：
1. 等待Token过期（默认2小时）
2. 或者修改代码，将Token有效期设置为很短的时间进行测试

**请求信息**：
- **方法**：GET
- **URL**：`http://localhost:8080/api/user/info`
- **Headers**：
  ```
  Authorization: Bearer <过期Token>
  ```

**预期响应**：
- **状态码**：401 Unauthorized
- **响应体**：
  ```json
  {
    "code": 401,
    "message": "Token已过期",
    "data": null,
    "timestamp": 1701590400000
  }
  ```

**验证点**：
- ✅ 状态码为401
- ✅ 返回过期错误信息

---

### 场景6：访问公开接口（不需要Token）

**测试目的**：验证公开接口可以正常访问，不需要Token

**请求信息**：
- **方法**：GET
- **URL**：`http://localhost:8080/api/public/hello`
- **Headers**：无

**预期响应**：
- **状态码**：200 OK
- **响应体**：
  ```json
  {
    "code": 200,
    "message": "success",
    "data": {
      "message": "这是公开接口，不需要Token"
    },
    "timestamp": 1701590400000
  }
  ```

**验证点**：
- ✅ 状态码为200
- ✅ 可以正常访问，不需要Token

---

## 3. 使用Postman测试

### 3.1 创建Postman Collection

**步骤1**：打开Postman，创建新的Collection，命名为"JWT测试"

**步骤2**：创建环境变量
- 创建Environment，添加变量：
  - `baseUrl`: `http://localhost:8080`
  - `token`: (空，登录后自动设置)

### 3.2 测试登录接口

**创建请求**：
- **Name**: 登录
- **Method**: POST
- **URL**: `{{baseUrl}}/api/login`
- **Headers**:
  ```
  Content-Type: application/json
  ```
- **Body** (raw JSON):
  ```json
  {
    "username": "admin",
    "password": "123456"
  }
  ```

**保存Token**：
- 在Tests标签页添加脚本：
  ```javascript
  var jsonData = pm.response.json();
  if (jsonData.data && jsonData.data.token) {
      pm.environment.set("token", jsonData.data.token);
  }
  ```

### 3.3 测试受保护接口

**创建请求**：
- **Name**: 获取用户信息
- **Method**: GET
- **URL**: `{{baseUrl}}/api/user/info`
- **Headers**:
  ```
  Authorization: Bearer {{token}}
  ```

### 3.4 运行测试

1. 先运行"登录"请求
2. 检查环境变量中是否保存了token
3. 运行"获取用户信息"请求
4. 验证返回结果

---

## 4. 使用curl测试

### 4.1 登录获取Token

```bash
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "123456"
  }'
```

**保存Token**：
```bash
# 将响应保存到文件
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}' \
  -o login_response.json

# 提取token（需要安装jq）
TOKEN=$(cat login_response.json | jq -r '.data.token')
echo $TOKEN
```

### 4.2 使用Token访问受保护接口

```bash
# 使用保存的Token
curl -X GET http://localhost:8080/api/user/info \
  -H "Authorization: Bearer $TOKEN"
```

### 4.3 测试无效Token

```bash
curl -X GET http://localhost:8080/api/user/info \
  -H "Authorization: Bearer invalid_token"
```

### 4.4 测试无Token访问

```bash
curl -X GET http://localhost:8080/api/user/info
```

---

## 5. 常见问题排查

### 问题1：登录成功但无法访问受保护接口

**可能原因**：
1. Token没有正确设置到Authorization头
2. JWT过滤器没有正确配置
3. SecurityConfig配置有问题

**排查步骤**：
1. 检查Authorization头的格式：`Bearer <token>`（注意Bearer后面有空格）
2. 检查JWT过滤器是否被添加到过滤器链
3. 检查SecurityConfig中的路径配置是否正确

### 问题2：总是返回401错误

**可能原因**：
1. Token过期
2. Token格式错误
3. JWT过滤器验证逻辑有问题

**排查步骤**：
1. 检查Token是否过期
2. 检查Token格式是否正确
3. 查看日志，看JWT过滤器是否执行
4. 检查JWT工具类的验证逻辑

### 问题3：公开接口也需要Token

**可能原因**：
1. SecurityConfig中的路径配置不正确
2. 路径匹配规则有问题

**排查步骤**：
1. 检查SecurityConfig中的permitAll()配置
2. 检查路径是否匹配（注意路径前缀）
3. 查看过滤器是否跳过了公开路径

### 问题4：CORS错误

**可能原因**：
1. 跨域请求没有配置CORS

**解决方案**：
在SecurityConfig中添加CORS配置：
```java
http.cors();
```

### 问题5：OPTIONS请求被拦截

**可能原因**：
1. JWT过滤器没有跳过OPTIONS请求

**解决方案**：
在JWT过滤器的shouldNotFilter()方法中：
```java
if ("OPTIONS".equals(request.getMethod())) {
    return true;
}
```

---

## 📝 测试检查清单

完成所有测试场景后，检查：

- [ ] 场景1：登录接口能正常返回Token
- [ ] 场景2：使用有效Token能访问受保护接口
- [ ] 场景3：不使用Token返回401错误
- [ ] 场景4：使用无效Token返回401错误
- [ ] 场景5：使用过期Token返回401错误
- [ ] 场景6：公开接口不需要Token可以访问

---

*文档更新时间：2025年12月2日*
